.abstract.merge:
  variables:
    GIT_STRATEGY: none
    MERGENONINTERACTIVE: "true" # "false" is also true! Runs not interactive if the variable exists.
    pushOptSkipCi: "true" # "false" is also true! Runs not interactive if the variable exists.
  image: ${TEST_IMAGE}
  needs: []
  tags:
    - custom-cache
  before_script:
    - !reference [.lib, script]
    - cp $DOCKER_GIT_CONFIG ~/.gitconfig
    - git_repo_clone_cached
    - git config --global user.email "gitlabci@metaways.de"
    - git config --global user.name "gitlabci"
    - git_repo_clone_cached ${CI_BUILDS_DIR}/merge
    - cd ${CI_BUILDS_DIR}/merge
    - git config merge.pofile.name "merge po-files driver"
    - git config merge.pofile.driver "${CI_BUILDS_DIR}/${CI_PROJECT_NAMESPACE}/tine20/scripts/git/merge-po-files %A %O %B"
    - git config merge.pofile.recursive "binary"
    - git remote add customers https://gitlab.metaways.net/tine20/tine20.git
    # TODO remove github.com when github.com/tine20/tine20 is obsolete
    - git remote add github.com https://github.com/tine20/tine20.git
    - git remote add github https://github.com/tine-groupware/tine.git
    - cd ${CI_BUILDS_DIR}/merge/tine20
    
# todo move custom merge to .abstract.merge and then delete this job
.abstract.merge_on_source_image:
  extends: .abstract.merge

include:
  - local: '/ci/gitlab-ci/custom_merge_jobs.yml'

merge:
  stage: merge1
  extends: .abstract.merge
  script:
    - merge_merge_upwards $TINE_VERSION_LTS $TINE_VERSION_BE
    - merge_merge_upwards $TINE_VERSION_BE $TINE_VERSION_BETA
    - merge_merge_upwards $TINE_VERSION_BETA $TINE_VERSION_NEXT
    - |
      if [ "${TINE_VERSION_BETA}" != "" ];then
        merge_merge_upwards $TINE_VERSION_BE $TINE_VERSION_BETA
        merge_merge_upwards $TINE_VERSION_BETA $TINE_VERSION_NEXT
      else
        merge_merge_upwards $TINE_VERSION_BE $TINE_VERSION_NEXT
      fi
    - merge_merge_mirror customers $TINE_VERSION_NEXT github main
    - merge_merge_mirror github main customers $TINE_VERSION_NEXT
    - merge_trigger_next
  rules:
    - if: $AUTO_MERGE == "never"
      when: never
    - if: $CI_PIPELINE_SOURCE == "push" && ($CI_COMMIT_REF_NAME == $TINE_VERSION_LTS || $CI_COMMIT_REF_NAME == $TINE_VERSION_BE || $CI_COMMIT_REF_NAME == $TINE_VERSION_BETA || $CI_COMMIT_REF_NAME == $TINE_VERSION_NEXT)
      variables:
        AUTO_MERGE_VAR: "true"
    - if: $AUTO_MERGE == "true"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /auto_merge/
    - if: $PIPELINE_TYPE =~ /auto-merge/
